{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}ชำระเงิน | Water Delivery{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  
  <style>
    /* --- Layout --- */
    .page-header { margin-bottom: 30px; }
    .page-title { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); margin: 0; }

    .checkout-container {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 30px;
      align-items: start;
    }

    /* --- Card Styles --- */
    .card-box {
      background: white;
      border-radius: var(--radius);
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
      border: 1px solid #eef2f7;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 1.1rem; font-weight: 600; color: var(--text-dark);
      margin-bottom: 20px; padding-bottom: 10px;
      border-bottom: 1px solid #f1f5f9;
      display: flex; align-items: center; gap: 10px;
    }
    .section-title i { color: var(--primary); }

    /* --- Inputs --- */
    .form-group { margin-bottom: 15px; }
    .label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
    
    .input, select.input {
      width: 100%; padding: 12px;
      border: 2px solid #eef2f7; border-radius: 12px;
      font-family: 'Kanit', sans-serif; font-size: 0.95rem;
      outline: none; transition: 0.3s; background: #fdfdfd;
    }
    .input:focus { border-color: var(--primary); background: white; }
    textarea.input { resize: vertical; min-height: 80px; }

    /* --- Map Style --- */
    #map {
      height: 300px; width: 100%;
      border-radius: 12px; border: 2px solid #eef2f7;
      margin-top: 10px; z-index: 1;
    }
    .btn-locate {
      background: #f1f5f9; color: var(--text-dark); border: 1px solid #cbd5e1;
      padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;
      display: inline-flex; align-items: center; gap: 5px; float: right;
    }
    .btn-locate:hover { background: #e2e8f0; }

    /* --- Payment Radio --- */
    .payment-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .payment-option input[type="radio"] { display: none; }
    .payment-card {
      border: 2px solid #eef2f7; border-radius: 12px; padding: 15px;
      text-align: center; cursor: pointer; transition: 0.3s;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      color: var(--text-gray);
    }
    .payment-card i { font-size: 1.5rem; margin-bottom: 5px; }
    .payment-card:hover { border-color: var(--primary); background: #f0fdf4; }
    .payment-option input[type="radio"]:checked + .payment-card {
      border-color: var(--primary); background: #d1fae5; color: var(--primary-dark);
      box-shadow: 0 4px 10px rgba(0, 184, 148, 0.2);
    }

    /* --- Summary --- */
    .summary-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem;
    }
    .summary-total {
      margin-top: 20px; padding-top: 15px; border-top: 2px solid #f1f5f9;
      display: flex; justify-content: space-between;
      font-size: 1.3rem; font-weight: 700; color: var(--text-dark);
    }
    .summary-total span:last-child { color: var(--primary); }

    .btn-confirm {
      width: 100%; padding: 14px; background: var(--primary); color: white;
      border: none; border-radius: 50px; font-weight: 600; font-size: 1.1rem;
      cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
      margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-confirm:hover { background: var(--primary-hover); transform: translateY(-2px); }

    @media (max-width: 850px) {
      .checkout-container { grid-template-columns: 1fr; }
      .checkout-container > div:first-child { order: 2; }
      .checkout-container > div:last-child { order: 1; }
    }
  </style>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">ยืนยันการสั่งซื้อ</h1>
</div>

<form method="post" action="">
  {% csrf_token %}
  
  <div class="checkout-container">
    
    <div>
      
      <div class="card-box">
        <div class="section-title" style="justify-content: space-between;">
          <span><i class="fas fa-map-marker-alt"></i> ที่อยู่จัดส่ง</span>
          <button type="button" onclick="locateUser()" class="btn-locate">
            <i class="fas fa-crosshairs"></i> ตำแหน่งปัจจุบัน
          </button>
        </div>
        
        <div class="form-group">
          <label class="label">ชื่อ-นามสกุล</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            {% render_field form.first_name class="input" placeholder="ชื่อจริง" %}
            {% render_field form.last_name class="input" placeholder="นามสกุล" %}
          </div>
        </div>
        
        <div class="form-group">
          <label class="label">เบอร์โทรศัพท์</label>
          {% render_field form.phone class="input" placeholder="08x-xxx-xxxx" %}
        </div>
        
        <div class="form-group">
          <label class="label">รายละเอียดที่อยู่</label>
          {% render_field form.address class="input" rows="2" placeholder="บ้านเลขที่, หมู่บ้าน, ซอย..." %}
        </div>

        <div class="form-group">
          <label class="label" style="color:var(--text-gray); font-size:0.85rem;">
            <i class="fas fa-info-circle"></i> ลากหมุดเพื่อระบุพิกัดจัดส่งที่แม่นยำ
          </label>
          <div id="map"></div>
          
          <input type="hidden" name="address_lat" id="address_lat" value="{{ form.address_lat.value|default:'' }}">
          <input type="hidden" name="address_lng" id="address_lng" value="{{ form.address_lng.value|default:'' }}">
        </div>

        <div class="form-group">
            <label class="label">หมายเหตุ (ถ้ามี)</label>
            <textarea name="note" class="input" placeholder="เช่น ฝากไว้ที่ป้อมยาม, ประตูบ้านสีฟ้า"></textarea>
        </div>
      </div>

      <div class="card-box">
        <div class="section-title">
          <i class="fas fa-clock"></i> เลือกรอบจัดส่ง
        </div>
        
        <div class="form-group">
          <select name="round_id" class="input" required>
            <option value="" disabled selected>-- กรุณาเลือกวันและเวลา --</option>
            {% for r in rounds %}
              <option value="{{ r.id }}">
                {{ r.date|date:'d/m/Y' }} - {{ r.get_time_slot_display }} 
                (ว่าง {{ r.remaining_capacity }} ที่)
              </option>
            {% empty %}
              <option value="" disabled>ไม่มีรอบจัดส่งที่ว่างในขณะนี้</option>
            {% endfor %}
          </select>
          <p style="font-size:0.8rem; color:var(--text-gray); margin-top:5px;">
            * หากรอบเต็ม ระบบจะจัดเข้าคิว (Waiting List) ให้โดยอัตโนมัติ
          </p>
        </div>
      </div>

      <div class="card-box">
        <div class="section-title">
          <i class="fas fa-wallet"></i> วิธีการชำระเงิน
        </div>
        
        <div class="payment-grid">
          <label class="payment-option">
            <input type="radio" name="payment_method" value="cod" checked>
            <div class="payment-card">
              <i class="fas fa-money-bill-wave"></i>
              <span>เก็บเงินปลายทาง</span>
            </div>
          </label>
          
          <label class="payment-option">
            <input type="radio" name="payment_method" value="transfer">
            <div class="payment-card">
              <i class="fas fa-qrcode"></i>
              <span>โอนเงิน / สแกนจ่าย</span>
            </div>
          </label>
        </div>
      </div>

    </div>

    <div>
      <div class="card-box" style="position: sticky; top: 100px;">
        <div class="section-title">
          <i class="fas fa-shopping-basket"></i> สรุปรายการ
        </div>

        {% for item in cart_items %}
        <div class="summary-item">
          <div>
            <div>{{ item.product.name }}</div>
            <small style="color:#aaa;">{{ item.product.size_litre }} L x {{ item.quantity }}</small>
          </div>
          <div>฿{{ item.total_price }}</div>
        </div>
        {% endfor %}

        <div class="summary-total">
          <span>ยอดสุทธิ</span>
          <span>฿{{ total_price }}</span>
        </div>

        <button type="submit" class="btn-confirm">
          ยืนยันการสั่งซื้อ <i class="fas fa-check-circle"></i>
        </button>
        
        <a href="{% url 'orders:cart' %}" style="display:block; text-align:center; margin-top:15px; color:#888; text-decoration:none; font-size:0.9rem;">
          ย้อนกลับไปแก้ไข
        </a>
      </div>
    </div>

  </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
  // --- Map Logic ---
  const map = L.map('map');
  const latInput = document.getElementById('address_lat');
  const lngInput = document.getElementById('address_lng');
  let marker;

  // 1. กำหนดพิกัดเริ่มต้น (ถ้ามีค่าเดิม ให้ใช้ค่าเดิม / ถ้าไม่มี ใช้ กทม.)
  let startLat = parseFloat(latInput.value) || 13.7563;
  let startLng = parseFloat(lngInput.value) || 100.5018;
  
  // กรณี value เป็นว่างๆ ("") ให้ใช้ Default
  if (isNaN(startLat)) startLat = 13.7563;
  if (isNaN(startLng)) startLng = 100.5018;

  map.setView([startLat, startLng], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
  }).addTo(map);

  // ฟังก์ชันปักหมุด
  function setMarker(lat, lng) {
      if (marker) {
          marker.setLatLng([lat, lng]);
      } else {
          marker = L.marker([lat, lng], {draggable: true}).addTo(map);
          // เมื่อลากหมุดเสร็จ ให้อัปเดตค่า
          marker.on('dragend', function(e) {
              const pos = e.target.getLatLng();
              updateInputs(pos.lat, pos.lng);
          });
      }
      // อัปเดตค่าลง Input
      updateInputs(lat, lng);
      map.setView([lat, lng], 15);
  }

  function updateInputs(lat, lng) {
      latInput.value = lat.toFixed(6);
      lngInput.value = lng.toFixed(6);
  }

  // สร้างหมุดเริ่มต้น
  setMarker(startLat, startLng);

  // คลิกแผนที่เพื่อย้ายหมุด
  map.on('click', function(e) {
      setMarker(e.latlng.lat, e.latlng.lng);
  });

  // ฟังก์ชันหาตำแหน่งปัจจุบัน
  function locateUser() {
      if(navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(position => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              setMarker(lat, lng);
          }, () => {
              alert('ไม่สามารถระบุตำแหน่งได้ กรุณาเปิด GPS');
          });
      } else {
          alert('เบราว์เซอร์ไม่รองรับ Geolocation');
      }
  }
  
  // แก้บั๊กแผนที่โหลดไม่เต็ม
  setTimeout(() => { map.invalidateSize(); }, 500);
</script>
{% endblock %}